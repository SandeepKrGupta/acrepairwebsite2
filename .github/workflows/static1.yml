name: Deploy static content to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

# Minimal permissions required for deployment
permissions:
  contents: read    # needed to checkout repo
  pages: write      # required to publish to Pages
  # id-token: write # keep commented unless you use OIDC in your flow

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (no token persistence)
        uses: actions/checkout@v4
        with:
          # do not persist the GITHUB_TOKEN to the workspace (reduces token exposure to later steps/actions)
          persist-credentials: false
          fetch-depth: 1

      - name: Prepare `public` folder for Pages
        # copy only what we need into a clean public/ directory to avoid uploading .github, .git, secrets, etc.
        run: |
          rm -rf public
          mkdir public

          # If there is an index.html already, use it. Otherwise:
          if [ -f "index.html" ]; then
            cp index.html public/
          elif [ -f "BubbleSection.html" ]; then
            # copy BubbleSection.html to public/index.html for Pages root.
            cp BubbleSection.html public/index.html
          else
            # fallback: copy any .html file into index.html (first match)
            first_html=$(ls *.html 2>/dev/null | head -n 1 || true)
            if [ -n "$first_html" ]; then
              cp "$first_html" public/index.html
            else
              echo "No HTML sources found to publish. Exiting."
              exit 1
            fi
          fi

          # copy other static assets if present (css, js, images, CNAME)
          cp -r --no-preserve=mode,ownership assets public/ 2>/dev/null || true
          [ -f CNAME ] && cp CNAME public/ || true
          # If you use a different folder structure, update the copy rules above.

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload only the prepared public folder
          path: ./public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
